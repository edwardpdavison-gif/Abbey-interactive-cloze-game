<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abbey Gap Fill Game</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea, select { width: 100%; padding: 8px; margin: 5px 0; font-size: 16px; }
    button { padding: 8px 16px; margin-right: 5px; }
    .small-button { padding: 4px 8px; font-size: 14px; margin-top: 5px; }

    /* Scrollable gapped text container */
    #clozeContainer {
      width: 70%;
      max-width: 1200px;
      min-height: 100px;
      max-height: 50vh;           /* dynamic height up to 50% of viewport */
      border: 1px solid #ccc;
      padding: 10px;
      overflow: auto;
      margin-top: 20px;
    }

    /* Gapped text styling */
    .output {
      display: block;
      white-space: normal;
      overflow-wrap: break-word;
      font-family: "Consolas", monospace;
      font-size: 12px;           /* small font */
      line-height: 1.8;
    }

    .word {
      display: inline-block;
      margin-right: 6px;
      letter-spacing: 2px;
    }

    .revealed {
      font-weight: bold;
    }

    .turn { font-weight: bold; color: green; }
    #gameInfo { margin-top: 10px; font-weight: bold; }

    #guessInput { width: 150px; padding: 5px; font-size: 14px; display: inline-block; }

    /* Flex layout for game controls */
    #gameControls {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin-top: 20px;
    }

    #guessSection {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Right panel: bank + scoreboard */
    #rightPanel {
      display: flex;
      flex-direction: row;
      gap: 20px;
    }

    /* Bank of failed guesses */
    #failedBankContainer {
      width: 300px;
      border: 1px solid #ccc;
      padding: 10px;
      height: auto;
      font-family: "Comic Sans MS", cursive, sans-serif;
      color: red;
      background-color: #ffe6e6;
    }

    /* Scoreboard */
    #scores {
      width: 150px;
    }
  </style>
</head>
<body>
  <h1>Abbey Gap Fill Game</h1>

  <!-- Setup Section -->
  <div id="setupSection">
    <div id="setupFields">
      <p>Select your subject and cohort, input your text, and choose number of players/teams.</p>

      <label>Subject:
        <select id="subject">
          <option value="">--Select Subject--</option>
          <option>Economics</option>
          <option>Maths</option>
          <option>Further Maths</option>
          <option>Chemistry</option>
          <option>Biology</option>
          <option>Physics</option>
          <option>Business Studies</option>
          <option>Accounting</option>
          <option>English</option>
          <option>Art and Design</option>
          <option>Politics</option>
          <option>Geography</option>
          <option>Psychology</option>
          <option>Computer Science</option>
          <option>Tutor time</option>
          <option>PE</option>
          <option>PSHE</option>
          <option>Boarding activity</option>
          <option>Tutor assembly</option>
          <option>Something else</option>
        </select>
      </label><br><br>

      <label>Cohort:
        <select id="cohort">
          <option value="">--Select Cohort--</option>
          <option>Yr13 A-level</option>
          <option>Yr12 A-level</option>
          <option>IFP</option>
          <option>Yr11</option>
          <option>Yr10</option>
          <option>Yr9</option>
          <option>Academic preparation</option>
          <option>Mixed</option>
          <option>Not applicable</option>
        </select>
      </label><br><br>

      <textarea id="inputText" placeholder="Type or paste your text here..."></textarea>

      <p>Select number of players/teams (1â€“4):</p>
      <select id="numPlayers">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
      <br><br>
    </div>

    <button id="generateBtn" onclick="startGame()">Generate Text</button><br>
    <button id="editOriginalBtn" class="small-button" onclick="editOriginalText()" style="display:none;">See/Edit Original Text</button>
  </div>

  <div id="gameInfo" style="display:none;"></div>

  <!-- Scrollable Gapped Text Container -->
  <div id="clozeContainer">
    <div id="clozeArea" class="output"></div>
  </div>

  <!-- Game Section -->
  <div id="gameSection" style="display:none;">
    <div id="gameControls">
      <!-- Left: guess input -->
      <div id="guessSection">
        <input type="text" id="guessInput" placeholder="Enter word">
        <button onclick="guessWord()">Guess Word</button>
      </div>

      <!-- Right: failed bank + scoreboard -->
      <div id="rightPanel">
        <div id="failedBankContainer">
          <h4>Bank of Failed Guesses:</h4>
          <div id="failedWords"></div>
        </div>
        <div id="scores" class="scores"></div>
      </div>
    </div>
  </div>

  <script>
    let wordElements = [];
    let originalText = '';
    let revealedWords = {};
    let failedGuesses = [];
    let players = [];
    let currentTurn = 0;
    let gameSubject = '';
    let gameCohort = '';
    let gameNumPlayers = 1;

function startGame() {
  const subject = document.getElementById('subject').value;
  const cohort = document.getElementById('cohort').value;

  if (!subject || !cohort) {
    alert("Please select both subject and cohort before generating text.");
    return;
  }

  const numPlayers = parseInt(document.getElementById('numPlayers').value);
  players = [];
  for (let i = 1; i <= numPlayers; i++) {
    players.push({ name: `Player ${i}`, score: 0 });
  }

  gameSubject = subject;
  gameCohort = cohort;
  gameNumPlayers = numPlayers;

  originalText = document.getElementById('inputText').value;
  if (!originalText.trim()) {
    alert("Please input some text to generate.");
    return;
  }

  // ðŸ”¹ Call Firebase session logging
  if (window.startSession) {
    window.startSession(subject, cohort, numPlayers);
  }

  // Hide setup fields, keep edit button
  document.getElementById('setupFields').style.display = 'none';
  document.getElementById('editOriginalBtn').style.display = 'inline-block';

  document.getElementById('gameSection').style.display = 'block';
  document.getElementById('gameInfo').style.display = 'block';
  updateGameInfo();

  renderCloze();
  updateScores();
  document.getElementById('guessInput').value = '';
  document.getElementById('guessInput').focus();
}

      // Hide setup fields, keep edit button
      document.getElementById('setupFields').style.display = 'none';
      document.getElementById('editOriginalBtn').style.display = 'inline-block';

      document.getElementById('gameSection').style.display = 'block';
      document.getElementById('gameInfo').style.display = 'block';
      updateGameInfo();

      renderCloze();
      updateScores();
      document.getElementById('guessInput').value = '';
      document.getElementById('guessInput').focus();
    }

    function updateGameInfo() {
      document.getElementById('gameInfo').textContent = 
        `Subject: ${gameSubject} | Cohort: ${gameCohort} | Players: ${gameNumPlayers}`;
    }

    function renderCloze() {
      const clozeArea = document.getElementById('clozeArea');
      clozeArea.innerHTML = '';
      wordElements = [];

      const paragraphs = originalText.split(/\n/);

      paragraphs.forEach((para, pIndex) => {
        const tokens = para.match(/\w+|[^\w\s]/g) || [];

        tokens.forEach((token, i) => {
          if (/^\w+$/.test(token)) {
            const span = document.createElement('span');
            span.className = 'word';
            const revealed = revealedWords[token.toLowerCase()] || false;
            if (revealed) {
              span.textContent = token;
              span.classList.add('revealed');
            } else {
              span.textContent = '_'.repeat(token.length);
            }
            wordElements.push({ element: span, word: token, revealed: revealed });
            clozeArea.appendChild(span);
          } else {
            clozeArea.appendChild(document.createTextNode(token));
          }

          const next = tokens[i + 1];
          if (next) {
            if (
              (/^\w+$/.test(token) && /^\w+$/.test(next)) ||        
              (/^\w+$/.test(token) && /[\(\â€œ"']/.test(next)) ||     
              (/[\)\.\,\!\?\:;']/.test(token) && /^\w+$/.test(next)) 
            ) {
              clozeArea.appendChild(document.createTextNode(' '));
            }
          }
        });

        if (pIndex < paragraphs.length - 1) {
          clozeArea.appendChild(document.createElement('br'));
        }
      });
    }

    function guessWord() {
      const guessInput = document.getElementById('guessInput');
      const guess = guessInput.value.trim().toLowerCase();
      if (!guess) return;

      let found = false;
      wordElements.forEach(item => {
        if (!item.revealed && item.word.toLowerCase() === guess) {
          item.element.textContent = item.word;
          item.element.classList.add('revealed');
          item.revealed = true;
          revealedWords[guess] = true;
          found = true;
        }
      });

      if (found) {
        players[currentTurn].score += 1;
      } else {
        if (!failedGuesses.includes(guess)) failedGuesses.push(guess);
        updateFailedBank();
      }

      updateScores();
      nextTurn();
      guessInput.value = '';
      guessInput.focus();
    }

    function nextTurn() {
      currentTurn = (currentTurn + 1) % players.length;
      updateScores();
    }

    function updateScores() {
      const scoresDiv = document.getElementById('scores');
      scoresDiv.innerHTML = '<h3>Scores:</h3>';
      players.forEach((player, idx) => {
        const turnIndicator = (idx === currentTurn) ? ' <span class="turn">#</span>' : '';
        scoresDiv.innerHTML += `<div>${player.name}: ${player.score}${turnIndicator}</div>`;
      });
    }

    function updateFailedBank() {
      const failedDiv = document.getElementById('failedWords');
      failedDiv.textContent = failedGuesses.join(', ');
    }

    function editOriginalText() {
      document.getElementById('setupFields').style.display = 'block';
    }

    document.getElementById('inputText').addEventListener('input', () => {
      originalText = document.getElementById('inputText').value;
      renderCloze();
    });
  </script>
   <!-- Firebase Integration -->
  <script type="module">
    // Import Firebase SDK modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc } 
      from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAsSuLmWKYEqH2NYdfB4G4bVv4IVfIgz1M",
      authDomain: "abbeygamebackend.firebaseapp.com",
      projectId: "abbeygamebackend",
      storageBucket: "abbeygamebackend.firebasestorage.app",
      messagingSenderId: "635113946883",
      appId: "1:635113946883:web:93704f424274e656d57336"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; // expose globally

    // Optional test write
    async function testWrite() {
      try {
        const docRef = await addDoc(collection(db, "testCollection"), {
          message: "Hello Firebase!",
          timestamp: new Date().toISOString()
        });
        console.log("Document written with ID:", docRef.id);
      } catch (e) {
        console.error("Error adding document:", e);
      }
    }

    testWrite(); // only for initial test; can remove later

    // --- Session logging ---
    function captureTexts() {
      const inputEl = document.getElementById("inputText");
      const clozeEl = document.getElementById("clozeArea");
      return {
        original: inputEl ? inputEl.value : null,
        cloze: clozeEl ? clozeEl.innerText : null
      };
    }

    async function startSession(subject, cohort, numPlayers) {
      const timestamp = new Date().toISOString().replace(/[-:T.]/g, "").slice(0,14);
      const sessionId = `${subject}-${cohort}-${timestamp}`;
      const sessionRef = doc(collection(db, "sessions"), sessionId);

      const { original, cloze } = captureTexts();

      const metadata = {
        subject,
        cohort,
        numPlayers,
        startTime: new Date(),
        originalText: original,
        clozeText: cloze
      };

      try {
        await setDoc(sessionRef, { metadata });
        console.log("Session started:", sessionId, metadata);
      } catch (error) {
        console.error("Error creating session:", error);
      }
    }

    // Expose globally so your frontend can call it
    window.startSession = startSession;
  </script>
</body>
</html>
