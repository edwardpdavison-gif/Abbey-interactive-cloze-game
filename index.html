<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abbey Gap Fill Game</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea, select { width: 100%; padding: 8px; margin: 5px 0; font-size: 16px; }
    button { padding: 8px 16px; margin-right: 5px; }
    .small-button { padding: 4px 8px; font-size: 14px; margin-top: 5px; }
    #clozeContainer { width: 70%; max-width: 1200px; min-height: 100px; max-height: 50vh; border: 1px solid #ccc; padding: 10px; overflow: auto; margin-top: 20px; }
    .output { display: block; white-space: normal; overflow-wrap: break-word; font-family: "Consolas", monospace; font-size: 12px; line-height: 1.8; }
    .word { display: inline-block; margin-right: 6px; letter-spacing: 2px; }
    .revealed { font-weight: bold; }
    .turn { font-weight: bold; color: green; }
    #gameInfo { margin-top: 10px; font-weight: bold; }
    #guessInput { width: 150px; padding: 5px; font-size: 14px; display: inline-block; }
    #gameControls { display: flex; align-items: flex-start; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
    #guessSection { display: flex; flex-direction: column; gap: 10px; }
    #rightPanel { display: flex; flex-direction: row; gap: 20px; }
    #failedBankContainer { width: 300px; border: 1px solid #ccc; padding: 10px; height: auto; font-family: "Comic Sans MS", cursive, sans-serif; color: red; background-color: #ffe6e6; }
    #scores { width: 150px; }
  </style>
</head>
<body>
  <h1>Abbey Gap Fill Game</h1>

  <!-- Setup Section -->
  <div id="setupSection">
    <div id="setupFields">
      <p>Select your subject and cohort, input your text, and choose number of players/teams.</p>

      <label>Subject:
        <select id="subject">
          <option value="">--Select Subject--</option>
          <option>Economics</option>
          <option>Maths</option>
          <option>Further Maths</option>
          <option>Chemistry</option>
          <option>Biology</option>
          <option>Physics</option>
          <option>Business Studies</option>
          <option>Accounting</option>
          <option>English</option>
          <option>Art and Design</option>
          <option>Politics</option>
          <option>Geography</option>
          <option>Psychology</option>
          <option>Computer Science</option>
          <option>Tutor time</option>
          <option>PE</option>
          <option>PSHE</option>
          <option>Boarding activity</option>
          <option>Tutor assembly</option>
          <option>Something else</option>
        </select>
      </label><br><br>

      <label>Cohort:
        <select id="cohort">
          <option value="">--Select Cohort--</option>
          <option>Yr13 A-level</option>
          <option>Yr12 A-level</option>
          <option>IFP</option>
          <option>Yr11</option>
          <option>Yr10</option>
          <option>Yr9</option>
          <option>Academic preparation</option>
          <option>Mixed</option>
          <option>Not applicable</option>
        </select>
      </label><br><br>

      <textarea id="inputText" placeholder="Type or paste your text here..."></textarea>

      <p>Select number of players/teams (1–4):</p>
      <select id="numPlayers">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
      <br><br>
    </div>

    <button id="generateBtn">Generate Text</button><br>
    <button id="editOriginalBtn" class="small-button" style="display:none;">See/Edit Original Text</button>
  </div>

  <div id="gameInfo" style="display:none;"></div>

  <div id="clozeContainer">
    <div id="clozeArea" class="output"></div>
  </div>

  <div id="gameSection" style="display:none;">
    <div id="gameControls">
      <div id="guessSection">
        <input type="text" id="guessInput" placeholder="Enter word">
        <button id="guessBtn">Guess Word</button>
        <!-- End Game button inside guessSection ensures it is visible -->
        <button id="endGameBtn" class="small-button" style="display:none; margin-top:10px;">End Game</button>
      </div>
      <div id="rightPanel">
        <div id="failedBankContainer">
          <h4>Bank of Failed Guesses:</h4>
          <div id="failedWords"></div>
        </div>
        <div id="scores" class="scores"></div>
      </div>
    </div>
  </div>

  <!-- Game Logic & Frontend -->
  <script type="module">
    window.addEventListener('DOMContentLoaded', () => {
      let wordElements = [];
      let originalText = '';
      let revealedWords = {};
      let failedGuesses = [];
      let players = [];
      let currentTurn = 0;
      let gameSubject = '';
      let gameCohort = '';
      let gameNumPlayers = 1;

      const endGameBtn = document.getElementById('endGameBtn');

      function updateGameInfo() {
        document.getElementById('gameInfo').textContent = 
          `Subject: ${gameSubject} | Cohort: ${gameCohort} | Players: ${gameNumPlayers}`;
      }

      function renderCloze() {
        const clozeArea = document.getElementById('clozeArea');
        clozeArea.innerHTML = '';
        wordElements = [];
        const paragraphs = originalText.split(/\n/);
        paragraphs.forEach((para, pIndex) => {
         // normalize curly/typographic apostrophes to straight apostrophe
const normalized = para.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g, "'");

// Try a Unicode-aware regex (supports accented letters and other scripts).
// If the browser doesn't support \p{L} (old browsers), fall back to an ASCII-friendly regex.
let tokens = null;
try {
  // Matches words with internal apostrophes or hyphens (e.g. "wouldn't", "state-of-the-art"),
  // numbers, or individual punctuation tokens.
  tokens = normalized.match(/\p{L}+(?:['-]\p{L}+)*|\d+|[^\p{L}\p{N}\s]/gu);
} catch (e) {
  // Fallback for browsers without Unicode property escape support
  tokens = normalized.match(/[A-Za-z0-9]+(?:['-][A-Za-z0-9]+)*|[^\w\s]/g);
}
tokens = tokens || [];

          tokens.forEach((token, i) => {
            if (/^\w+$/.test(token)) {
              const span = document.createElement('span');
              span.className = 'word';
              const revealed = revealedWords[token.toLowerCase()] || false;
              span.textContent = revealed ? token : '_'.repeat(token.length);
              if (revealed) span.classList.add('revealed');
              wordElements.push({ element: span, word: token, revealed });
              clozeArea.appendChild(span);
            } else clozeArea.appendChild(document.createTextNode(token));
            const next = tokens[i+1];
            if(next && ((/^\w+$/.test(token) && /^\w+$/.test(next)) || (/^\w+$/.test(token) && /[\(\“"']/.test(next)) || (/[\)\.\,\!\?\:;']/.test(token) && /^\w+$/.test(next)))) {
              clozeArea.appendChild(document.createTextNode(' '));
            }
          });
          if(pIndex<paragraphs.length-1) clozeArea.appendChild(document.createElement('br'));
        });
      }

      function updateScores() {
        const scoresDiv = document.getElementById('scores');
        scoresDiv.innerHTML = '<h3>Scores:</h3>';
        players.forEach((player, idx) => {
          const turnIndicator = (idx === currentTurn) ? ' <span class="turn">#</span>' : '';
          scoresDiv.innerHTML += `<div>${player.name}: ${player.score}${turnIndicator}</div>`;
        });
      }

      function updateFailedBank() {
        document.getElementById('failedWords').textContent = failedGuesses.join(', ');
      }

      function nextTurn() {
        currentTurn = (currentTurn + 1) % players.length;
        updateScores();
      }

      function guessWord() {
        const guessInput = document.getElementById('guessInput');
        const guess = guessInput.value.trim().toLowerCase();
        if (!guess) return;

        let found = false;
        wordElements.forEach(item => {
          if(!item.revealed && item.word.toLowerCase() === guess){
            item.element.textContent = item.word;
            item.element.classList.add('revealed');
            item.revealed = true;
            revealedWords[guess] = true;
            found = true;
          }
        });

        if(found) players[currentTurn].score +=1;
        else if(!failedGuesses.includes(guess)) {
          failedGuesses.push(guess);
          updateFailedBank();
        }

        nextTurn();
        guessInput.value='';
        guessInput.focus();

        if(window.logGuessEvent) window.logGuessEvent(gameSubject, gameCohort, currentTurn+1, guess, found);
      }

      function startGame() {
        const subject = document.getElementById('subject').value;
        const cohort = document.getElementById('cohort').value;
        if(!subject || !cohort){ alert("Please select both subject and cohort before generating text."); return; }

        const numPlayers = parseInt(document.getElementById('numPlayers').value);
        players = [];
        for(let i=1;i<=numPlayers;i++) players.push({name:`Player ${i}`,score:0});

        gameSubject = subject; gameCohort = cohort; gameNumPlayers=numPlayers;
        originalText = document.getElementById('inputText').value;
        if(!originalText.trim()){ alert("Please input some text to generate."); return; }

        if(window.startSession) window.startSession(subject, cohort, numPlayers);

        document.getElementById('setupFields').style.display='none';
        document.getElementById('editOriginalBtn').style.display='inline-block';
        document.getElementById('gameSection').style.display='block';
        document.getElementById('gameInfo').style.display='block';
        endGameBtn.style.display='block';

        updateGameInfo(); renderCloze(); updateScores();
        document.getElementById('guessInput').value=''; document.getElementById('guessInput').focus();
      }

      function endGame() {
        const missedWords = [];
        wordElements.forEach(item => {
          if(!item.revealed){
            item.element.textContent=item.word;
            item.element.classList.add('revealed');
            missedWords.push(item.word);
          }
        });
        if(window.endSession) window.endSession(gameSubject, gameCohort, gameNumPlayers, players, missedWords);
        endGameBtn.disabled = true;
      }

      document.getElementById('generateBtn').addEventListener('click', startGame);
      document.getElementById('guessBtn').addEventListener('click', guessWord);
      document.getElementById('editOriginalBtn').addEventListener('click', () => document.getElementById('setupFields').style.display='block');
      endGameBtn.addEventListener('click', endGame);
      document.getElementById('inputText').addEventListener('input', () => { originalText=document.getElementById('inputText').value; renderCloze(); });
    });
  </script>

  <!-- Firebase Integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAsSuLmWKYEqH2NYdfB4G4bVv4IVfIgz1M",
      authDomain: "abbeygamebackend.firebaseapp.com",
      projectId: "abbeygamebackend",
      storageBucket: "abbeygamebackend.firebasestorage.app",
      messagingSenderId: "635113946883",
      appId: "1:635113946883:web:93704f424274e656d57336"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db=db;

    function captureTexts() {
      const inputEl=document.getElementById("inputText");
      const clozeEl=document.getElementById("clozeArea");
      return {original:inputEl?inputEl.value:null, cloze:clozeEl?clozeEl.innerText:null};
    }

    async function startSession(subject, cohort, numPlayers){
      const timestamp=new Date().toISOString().replace(/[-:T.]/g,"").slice(0,14);
      const sessionId=`${subject}-${cohort}-${timestamp}`;
      const sessionRef=doc(collection(db,"sessions"),sessionId);
      const {original, cloze}=captureTexts();
      if(!original || !cloze) return;
      const metadata={subject, cohort, numPlayers, startTime:new Date(), originalText:original, clozeText:cloze};
      try{ await setDoc(sessionRef,{metadata}); window.currentSessionId=sessionId; } catch(e){console.error(e);}
    }

    async function logGuessEvent(subject, cohort, playerNum, guess, correct){
      if(!window.currentSessionId) return;
      const eventRef=doc(collection(db,"sessions",window.currentSessionId,"events"));
      const eventData={timestamp:new Date(), event:"guess", subject, cohort, player:playerNum, wordGuessed:guess, correct};
      try{ await setDoc(eventRef,eventData); } catch(e){console.error(e);}
    }

    async function endSession(subject, cohort, numPlayers, finalScores, missedWords){
      if(!window.currentSessionId) return;
      const sessionRef=doc(collection(db,"sessions"),window.currentSessionId);
      try{ await setDoc(sessionRef,{endTime:new Date(), finalScores, missedWords},{merge:true}); }
      catch(e){console.error(e);}
    }

    window.startSession=startSession;
    window.logGuessEvent=logGuessEvent;
    window.endSession=endSession;
  </script>
</body>
</html>









